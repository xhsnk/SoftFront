<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>音乐播放</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-table.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-table-zh-CN.min.js"></script>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
       body{
          background-color: #d4edda;
       }
        /***********头部的导航栏*******/
        .head{
            position: relative;
            width: 100%;
            height: 100px;
            background-color: #1d2124;
        }
        .lable, .loginIn{
            width: 200px;
            height: 100%;
            margin-left: 150px;
            font-size: 35px;
            line-height: 100px;
            display: inline-block;
            color: #FFFFFF;
        }
        .headTab{
            margin: 0;
            padding: 0;
            display: inline-block;
            width: 800px;
            height: 100%;
            list-style: none;
            line-height: 100px;
            font-size: 20px;
        }
        .headTab li{
            display: inline-block;
            width: 120px;
            text-align: center;
            color: #b9bbbe;
        }
        .head li:hover{
            background-color: #000000;
            color: #FFFFFF;
            height: 94px;
        }
        .head_search{
            display: inline-block;
            position: absolute;
            top: 25px;
            right: 490px;
            background-color: white;
            width: 300px;
            height: 50px;
            border-radius: 30px;
        }
        .head_search img{
            margin-left: 8px;
        }
        #search{
            display: inline-block;
            width: 70%;
            height: 100%;
            border: 0;
            outline:none;
            color: black;
        }
        .loginIn{
            position: absolute;
            top: 23px;
            right: 250px;
            width: 150px;
            height: 55px;
            font-size: 27px;
            line-height: 55px;
            text-align: center;
            color: #d5d5d5;
            border-radius: 30px;
            border: 2px solid #d5d5d5;
        }
        .loginIn:hover{
            color: #FFFFFF;
            border: 3px solid #FFFFFF;
        }
        .main{
            position: relative;
            width: 100%;
        }
        /************旋转唱片*********/
        .circle-song{
            position: absolute;
            top: 50px;
            left: 180px;
            width: 650px;
            height: 650px;
            background-image: url("img/songBg.jpg");
            background-position: center;
            background-size: 100% 100%;
            border-radius: 50%;
            text-align: center;
            line-height: 650px;
        }
        .circle-song img{
            width: 80%;
            height: 80%;
            border-radius: 50%;
        }
        #last, #next{
            position: absolute;
            top: 300px;
            left: 50px;
            width: 130px;
            height: 130px;
        }
        #next{
            left: 850px;
        }
        #last:hover,#next:hover{
            top: 298px;
        }
        #last:active,#next:active{
            top: 300px;
        }

        /************歌曲信息*********/
        .info{
            position: absolute;
            top: 150px;
            right: 250px;
            width: 650px;
            height: 550px;
           /*background-color: #FFFFFF;*/
            border-radius: 30px;
        }
        .songName{
            position: absolute;
            top: 70px;
            right: 300px;
            height: 90px;
            line-height: 90px;
            width: 600px;
            font-size: 30px;
        }
        .infoInner{
            width: 100%;
            height: 100%;
            position: relative;
        }
        .btn{
            font-size: 22px;
            margin-right: 30px;
        }
        .btn img{
            margin-right: 10px;
        }
        .list-group{
            margin-top: 40px;
            width: 85%;
            height: 80%;
            overflow-y: scroll;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .table{
            border-radius: 5px;
        }

        /************歌曲播放*********/
        #music-player{
            position: fixed;
            bottom: -10px;
            z-index: 9999;
            width: 100%;
        }
        #music-player audio{
            width: 100%;
            outline: none
        }
        #myAudio{
            height: 100px;
        }

        /************评论*********/
        .comment{
            position: absolute;    /*相对于整个文档定位*/
            top: 800px;
            left: 0;
            right: 0;
            padding: 40px 20px;
            margin: auto;
            width: 65%;
            border-radius: 30px;
            /*background-color: #ececf6;*/
        }
        .comment_line,#comment_line{
            width: 90%;
            height: 50px;
            font-size: 30px;
            font-family:Arial,Helvetica,sans-serif;
            line-height: 50px;
            padding-left: 15px;
            border-bottom: 3px solid green;
        }
        .myCmt{
            width: 90%;
            height: 280px;
            margin-top: 30px;
            background-color: #FFFFFF;
            position: relative;
        }
        .myCmt .userName{
            position: absolute;
            top: 10px;
            left: 10px;
            height: 50px;
            width: 180px;
            color: #34ce57;
            text-align: center;
            line-height: 50px;
            font-size:26px;
        }
        .form-group{
            position: absolute;
            top: 10px;
            left: 200px;
            width: 80%;
            height: 50%;
        }
        .form-control{
            width: 100%;
            height: 100%;
        }
        .lookCmt{
            width: 90%;
            background-color: #FFFFFF;
        }
        #comts>tbody>tr>td{ border-left: 0;border-right: 0;}
        #comts>thead>tr>th{ border: 0 }
        #postComt{
            position: absolute;
            bottom: 40px;
            right: 50px;
            width: 100px;
        }
        .noUse{
            width: 100%;
            height: 150px;
        }
        #comment_line{
            width: 100%;
        }
        /************滚动条*********/
        .list-group::-webkit-scrollbar {
            /*滚动条整体样式*/
            width : 6px;  /*高宽分别对应横竖滚动条的尺寸*/
            height: 1px;
        }
        .list-group::-webkit-scrollbar-thumb {
            /*滚动条里面小方块*/
            border-radius: 6px;
            box-shadow   : inset 0 0 5px rgba(0, 0, 0, 0.2);
            background   : #34ce57;
        }
        .list-group::-webkit-scrollbar-track {
            /*滚动条里面轨道*/
            box-shadow   : inset 0 0 5px rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            background   : #ededed;
        }


    </style>
    <script>
        $(function(){

            // 获取上个页面参数
            let url = window.location.href;
            let songId = url.split("="); //截取 url中的“=”,获得“=”后面的参数
            let songItem = {};

            // 定义一个随机生成评论用户的方法
            function comtAuthor() {
                const author = ["龚梅梅","王慧慧","王彬洁","曹进莹","丁江","李小响","王鑫鑫","吴小迪","西红柿纽扣","不知名人士",
                    "吃粽子的瓜","吃猹的闰土","博君一肖是真的","搜狗音乐官方","风一吹就瘦了","一支小鱼茗","我磕的cp是真的","班草","追风少年刘有权","一夜暴富",]
                    //x上限，y下限
                    const x = 19;
                    const y = 0;
                    var rand = parseInt(Math.random() * (x - y + 1) + y);
                    const user = author[rand]
                return user;
            }


            // 根据歌曲Id获取歌曲信息，并进入该歌曲的播放  ajax请求需要同步！！！！
            function songInfo(songId){
                let name = '';
                $.ajax({
                    url: `http://localhost:8088/songs/querySongById?id=${songId}`,
                    type: "POST",
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        name = `${data.name} — ${data.author}`
                        chang_music(data.url)
                        const string = JSON.stringify(data);
                        songItem = JSON.parse(string)
                    }
                })
                $(".songName").text(name)
                getData(songItem.name)  //根据歌曲名获取评论

            }
            songInfo(songId[1]);

            // 根据歌曲名获取所在歌单
            function getSheet() {
                $.ajax({
                    url: 'http://localhost:8088/songs/querySongByAscription?ascription=贝多芬的悲伤',
                    type: "POST",
                    dataType: "json",
                    // async: false,
                    success: function (data) {
                        songTblInit(data);
                    }
                })
            }
            getSheet();

            // 初始化歌曲表格
            function songTblInit(data){
                $('#songList').bootstrapTable({
                    columns: [{
                        field: 'name',
                        title: '',
                        align: 'center',
                        color: '#34ce57'
                    }],
                    data: data,
                    onClickRow:function(row, $element,field){
                        songInfo(row.id)
                        $("#myAudio")[0].play()
                    }
                });
                $('#songList').bootstrapTable('hideLoading')
            };

            //获取评论数据
            function getData(aim){
                $.ajax({
                    url: `http://localhost:8088/comment/selectAllCommentsByName?aim=${aim}`,
                    type: "POST",
                    dataType: "json",
                    success: function (data) {
                        tableInit(data)
                    }
                });
            }
            // 初始化评论表格(被调用)
            function tableInit(comments){
                $('#comts').bootstrapTable('destroy');
                $('#comts').bootstrapTable({
                    columns: [{
                        field: 'author',
                        title: '',
                        width: '220px',
                        halign: 'center',
                        align: 'center',
                        backgroundColor: 'red'
                    }, {
                        field: 'content',
                        title: '',
                        halign: 'center'
                    }],
                    cellStyle:{
                        css:{"background-color":"red"}
                    },
                    data: comments,
                    onClickRow:function(row, $element,field){
                        var i = $element.data('index');//可通过此参数获取当前行号
                        console.log(row)
                    }
                });
                $('#comts').bootstrapTable('hideLoading')
            };

            // 进入某一首歌的播放，参数为歌曲路径(一般被调用)
            function chang_music(songName) {
                $(".songName").text(`${songItem.name} — ${songItem.author}`)
                $("#music-player").html("")
                let aud = $(' <audio id="myAudio" controls>\n' +
                    '  <source src="'+songName+'">\n' +
                    ' </audio>');
                //放到容器里区
                $("#music-player").html(aud)
                //获取当前audio
                var audio = $("#myAudio")[0];
                //局部load()一下
                aud.load();
                status();
                // audio.play();
            }

            //上下首切换（被调用）
            function nextLast(num) {
                const changSong = songItem.id + num;
                songInfo(changSong)
            };
            $("#next").click(() => {
                nextLast(1)
                $("#myAudio")[0].play()
            });
            $("#last").click(() => {
                nextLast(-1)
                $("#myAudio")[0].play()
            });


            //监听音乐播放状态
            function status(){
                let rotate;  //唱片旋转定时器
                let audioStatus = "paused";
                let audio = document.getElementById("myAudio");
                audio.addEventListener("playing", function(){
                    audioStatus = "playing";
                    rotate = setInterval(circle_rotate, 20)
                });
                audio.addEventListener("pause", function(){
                    audioStatus = "paused";
                    clearInterval(rotate)
                });
            }
            status();

            //唱片旋转函数
            let degree = 0;
            function circle_rotate() {
                degree = degree+ 35 * Math.PI / 180;
                $(".circle-song").css("transform", "rotate("+degree+"deg)");
            }

            //发布评论
            function postComt() {
                let param = {
                    author: "默认用户",
                    commentAim: "string",
                    content: "string",
                    id: 0,
                    praisePoints: 0,
                    publicationTime: "string",
                    replayId: "string"
                };
                param.author = comtAuthor();
                param.content = $("#comment").val();
                param.commentAim = songItem.name;
                console.log(param)
                $.ajax({
                    url: 'http://localhost:8088/comment/addComments',
                    data: JSON.stringify(param),
                    type: "POST",
                    dataType: "json",
                    async: false,
                    contentType: "application/json",
                    success: function (data) {}
                });
                getData(songItem.name) //再一次查询评论数据，渲染表格
                $("#comment").val('');  //清空评论框
            }
            $("#postComt").click(() => {
                postComt()
            });

            // 返回主页面
            $(".loginIn").click(() => {
                window.location.href="index..html?_ijt=6aid4g15ufn1cl52njrm81e20u"
            });

        })
    </script>
</head>
<!--<body class='particle-network-animation'>-->
<body>
<!---------------------------------------上面的导航栏部分------------------------------->
    <div class="head">
        <div class="lable">湖音乐</div>
        <ul class="headTab">
            <li>发现音乐</li>
            <li>我的音乐</li>
            <li>朋友</li>
            <li>商城</li>
            <li>音乐人</li>
            <li>下载客户端</li>
        </ul>
        <div class="head_search">
            <img src="img/search.png" alt="404">
            <input type="text" id="search" placeholder="歌名/歌手/专辑"/>
        </div>
        <div class="loginIn">主 页</div>
    </div>
<!---------------------------------------播放音乐部分------------------------------->
    <div class="main">
        <!---------------------------------------旋转唱片------------------------------->
        <div  class="circle-song">
            <img src="img/专辑.jpg" alt="404"/>
        </div>
        <div id="last"><img src="img/last.png"></div>
        <div id="next"><img src="img/next.png"></div>
        <div class="songName"></div>
        <div class="info">
            <div class="infoInner">
                <div class="btnList">
                    <button type="button" class="btn btn-success"><img src="img/点赞2.png">    点赞</button>
                    <button type="button" class="btn btn-success"><img src="img/收藏.png">     收藏</button>
                    <button type="button" class="btn btn-success"><img src="img/下载.png">     下载</button>
                    <button type="button" class="btn btn-success"><img src="img/分享.png">     分享</button>
                </div>
                <div class="list-group">
                  <table class="table table-hover" id="songList"></table>
                </div>
            </div>
        </div>
        <div id="music-player">
            <audio id="myAudio" controls>
                <source src="music/菊次郎的夏天.mp3" type="audio/mpeg">
            </audio>
        </div>
        <!---------------------------------------旋转唱片------------------------------->
        <div class="comment">
            <div class="comment_line">评   论</div>
    <!-------------------添加评论----------->
            <div class="myCmt">
                <div class="userName">添加评论：</div>
                <div class="form-group" id="form">
                    <input type="text" class="form-control" id="comment"
                           placeholder="评论">
                </div>
                <div class="comBtn">
                <button type="button"  id="postComt" class="btn btn-success" >发  布</button>
                </div>
            </div>
    <!-------------------查看评论----------->
            <div class="lookCmt">
                <div id="comment_line"></div>
                <table class="table table-hover" id="comts"></table>
            </div>
            <div class="noUse"></div>


        </div>
    </div>
</body>
</html>
